import React, { useState, useMemo, useCallback } from 'react';
import { 
  HierarchicalSubject, 
  LargeCategory, 
  MediumCategory, 
  SmallCategory,
  MATH_HIERARCHICAL 
} from '../types/hierarchicalCurriculum';
import { KidsButton, KidsCard, StudyStartButton } from './ui/KidsUIComponents';
import { Subject, Topic } from '../types';

interface ImprovedHierarchicalSelectorProps {
  onStartLearning: (subject: Subject, topic: Topic) => void;
  disabled: boolean;
}

type SelectionStep = 'large' | 'medium' | 'small' | 'confirm';

interface SelectionState {
  step: SelectionStep;
  selectedLarge: LargeCategory | null;
  selectedMedium: MediumCategory | null;
  selectedSmall: SmallCategory | null;
}

const ImprovedHierarchicalSelector: React.FC<ImprovedHierarchicalSelectorProps> = ({ 
  onStartLearning, 
  disabled 
}) => {
  const [selectionState, setSelectionState] = useState<SelectionState>({
    step: 'large',
    selectedLarge: null,
    selectedMedium: null,
    selectedSmall: null
  });

  const [searchTerm, setSearchTerm] = useState('');
  const [selectedDifficultyFilter, setSelectedDifficultyFilter] = useState<number | null>(null);
  const [recentSelections, setRecentSelections] = useState<string[]>(() => {
    const stored = localStorage.getItem('recent_topic_selections');
    return stored ? JSON.parse(stored) : [];
  });

  // Ê§úÁ¥¢„Å®„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
  const filteredItems = useMemo(() => {
    const { step, selectedLarge, selectedMedium } = selectionState;
    
    if (step === 'large') {
      return MATH_HIERARCHICAL.largeCategories.filter(category =>
        category.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        category.description.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }
    
    if (step === 'medium' && selectedLarge) {
      return selectedLarge.mediumCategories.filter(category =>
        category.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        category.description.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }
    
    if (step === 'small' && selectedMedium) {
      return selectedMedium.smallCategories.filter(category => {
        const matchesSearch = category.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            category.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            category.keywords.some(keyword => 
                              keyword.toLowerCase().includes(searchTerm.toLowerCase())
                            );
        const matchesDifficulty = selectedDifficultyFilter === null || 
                                 Math.abs(category.difficulty - selectedDifficultyFilter) <= 1;
        return matchesSearch && matchesDifficulty;
      });
    }
    
    return [];
  }, [selectionState, searchTerm, selectedDifficultyFilter]);

  // Èõ£ÊòìÂ∫¶„É©„Éô„É´
  const getDifficultyLabel = useCallback((difficulty: number): string => {
    if (difficulty <= 3) return 'Âü∫Á§é';
    if (difficulty <= 6) return 'Ê®ôÊ∫ñ';
    if (difficulty <= 8) return 'ÂøúÁî®';
    return 'Áô∫Â±ï';
  }, []);

  // Èõ£ÊòìÂ∫¶Ëâ≤
  const getDifficultyColor = useCallback((difficulty: number): string => {
    if (difficulty <= 3) return 'bg-green-500';
    if (difficulty <= 6) return 'bg-blue-500';
    if (difficulty <= 8) return 'bg-orange-500';
    return 'bg-red-500';
  }, []);

  // ÈÅ∏Êäû„Éè„É≥„Éâ„É©„Éº
  const handleLargeSelect = useCallback((category: LargeCategory) => {
    console.log('Â§ßÂçòÂÖÉÈÅ∏Êäû:', category.name);
    setSelectionState({
      step: 'medium',
      selectedLarge: category,
      selectedMedium: null,
      selectedSmall: null
    });
    setSearchTerm('');
  }, []);

  const handleMediumSelect = useCallback((category: MediumCategory) => {
    console.log('‰∏≠ÂçòÂÖÉÈÅ∏Êäû:', category.name);
    setSelectionState(prev => ({
      ...prev,
      step: 'small',
      selectedMedium: category,
      selectedSmall: null
    }));
    setSearchTerm('');
  }, []);

  const handleSmallSelect = useCallback((category: SmallCategory) => {
    console.log('Â∞èÂçòÂÖÉÈÅ∏Êäû:', category.name);
    setSelectionState(prev => ({
      ...prev,
      step: 'confirm',
      selectedSmall: category
    }));
    
    // ÊúÄËøë„ÅÆÈÅ∏Êäû„Å´ËøΩÂä†
    const newRecent = [category.id, ...recentSelections.filter(id => id !== category.id)].slice(0, 5);
    setRecentSelections(newRecent);
    localStorage.setItem('recent_topic_selections', JSON.stringify(newRecent));
  }, [recentSelections]);

  // Êàª„Çã„Éú„Çø„É≥
  const handleBack = useCallback(() => {
    const { step } = selectionState;
    if (step === 'medium') {
      setSelectionState({
        step: 'large',
        selectedLarge: null,
        selectedMedium: null,
        selectedSmall: null
      });
    } else if (step === 'small') {
      setSelectionState(prev => ({
        ...prev,
        step: 'medium',
        selectedMedium: null,
        selectedSmall: null
      }));
    } else if (step === 'confirm') {
      setSelectionState(prev => ({
        ...prev,
        step: 'small',
        selectedSmall: null
      }));
    }
    setSearchTerm('');
  }, [selectionState]);

  // Â≠¶ÁøíÈñãÂßã
  const handleStartLearning = useCallback(() => {
    const { selectedSmall } = selectionState;
    if (!selectedSmall) return;

    console.log('Â≠¶ÁøíÈñãÂßã:', selectedSmall.name);
    
    const subject: Subject = {
      id: 'math',
      name: 'ÁÆóÊï∞',
      description: MATH_HIERARCHICAL.description,
      topics: [],
      examWeight: {
        basic: 0.8,
        standard: 0.8,
        advanced: 0.9,
        elite: 1.0
      }
    };

    const topic: Topic = {
      id: selectedSmall.id,
      name: selectedSmall.name,
      description: selectedSmall.description,
      subUnits: [],
      gradeLevel: ['5th'],
      estimatedHours: selectedSmall.estimatedHours,
      difficulty: selectedSmall.difficulty,
      examFrequency: {
        basic: 0.7,
        standard: 0.8,
        advanced: 0.9,
        elite: 1.0
      },
      learningObjectives: [selectedSmall.description]
    };

    onStartLearning(subject, topic);
  }, [selectionState, onStartLearning]);

  // „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº
  const renderStepIndicator = () => {
    const steps = [
      { key: 'large', label: 'Â§ßÂçòÂÖÉ', icon: 'üìÇ' },
      { key: 'medium', label: '‰∏≠ÂçòÂÖÉ', icon: 'üìÅ' },
      { key: 'small', label: 'Â∞èÂçòÂÖÉ', icon: 'üìÑ' },
      { key: 'confirm', label: 'Á¢∫Ë™ç', icon: '‚úÖ' }
    ];

    const currentStepIndex = steps.findIndex(s => s.key === selectionState.step);

    return (
      <div className="flex items-center justify-center space-x-2 mb-6">
        {steps.map((step, index) => {
          const isActive = index === currentStepIndex;
          const isCompleted = index < currentStepIndex;
          const isClickable = index < currentStepIndex;

          return (
            <React.Fragment key={step.key}>
              <button
                onClick={isClickable ? () => {
                  if (index === 0) setSelectionState({ step: 'large', selectedLarge: null, selectedMedium: null, selectedSmall: null });
                  else if (index === 1 && selectionState.selectedLarge) setSelectionState(prev => ({ ...prev, step: 'medium', selectedMedium: null, selectedSmall: null }));
                  else if (index === 2 && selectionState.selectedMedium) setSelectionState(prev => ({ ...prev, step: 'small', selectedSmall: null }));
                } : undefined}
                className={`flex items-center space-x-2 px-4 py-2 rounded-lg transition-all ${
                  isActive 
                    ? 'bg-blue-500 text-white scale-105' 
                    : isCompleted 
                    ? 'bg-green-500 text-white hover:bg-green-600 cursor-pointer' 
                    : 'bg-gray-200 text-gray-500'
                }`}
                disabled={!isClickable}
              >
                <span className="text-lg">{step.icon}</span>
                <span className="font-medium text-sm">{step.label}</span>
              </button>
              {index < steps.length - 1 && (
                <div className={`h-1 w-8 ${isCompleted ? 'bg-green-500' : 'bg-gray-300'}`} />
              )}
            </React.Fragment>
          );
        })}
      </div>
    );
  };

  // Ê§úÁ¥¢„Éê„Éº
  const renderSearchBar = () => {
    if (selectionState.step === 'confirm') return null;

    return (
      <div className="mb-4 space-y-3">
        <div className="relative">
          <input
            type="text"
            placeholder={`${selectionState.step === 'large' ? 'Â§ßÂçòÂÖÉ' : selectionState.step === 'medium' ? '‰∏≠ÂçòÂÖÉ' : 'Â∞èÂçòÂÖÉ'}„ÇíÊ§úÁ¥¢...`}
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-3 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
          />
          <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-blue-500">
            üîç
          </div>
          {searchTerm && (
            <button
              onClick={() => setSearchTerm('')}
              className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
            >
              ‚úï
            </button>
          )}
        </div>

        {selectionState.step === 'small' && (
          <div className="flex flex-wrap gap-2 items-center">
            <span className="text-sm font-medium text-gray-700">Èõ£ÊòìÂ∫¶„Éï„Ç£„É´„Çø„Éº:</span>
            {[null, 3, 6, 8, 10].map(level => (
              <button
                key={level || 'all'}
                onClick={() => setSelectedDifficultyFilter(level)}
                className={`px-3 py-1 rounded-full text-sm transition-colors ${
                  selectedDifficultyFilter === level
                    ? 'bg-blue-500 text-white'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                {level === null ? '„Åô„Åπ„Å¶' : getDifficultyLabel(level)}
              </button>
            ))}
          </div>
        )}
      </div>
    );
  };

  // „Éë„É≥„Åè„Åö„É™„Çπ„Éà
  const renderBreadcrumb = () => {
    const { selectedLarge, selectedMedium, selectedSmall } = selectionState;
    
    return (
      <div className="bg-blue-50 p-3 rounded-lg mb-4">
        <div className="flex items-center flex-wrap gap-2 text-sm">
          <span className="text-blue-600 font-medium">üìö ÁÆóÊï∞</span>
          {selectedLarge && (
            <>
              <span className="text-gray-400">‚Üí</span>
              <span className="text-blue-600 font-medium">{selectedLarge.name}</span>
            </>
          )}
          {selectedMedium && (
            <>
              <span className="text-gray-400">‚Üí</span>
              <span className="text-blue-600 font-medium">{selectedMedium.name}</span>
            </>
          )}
          {selectedSmall && (
            <>
              <span className="text-gray-400">‚Üí</span>
              <span className="text-blue-600 font-medium">{selectedSmall.name}</span>
            </>
          )}
        </div>
      </div>
    );
  };

  // Â§ßÂçòÂÖÉË°®Á§∫
  const renderLargeCategories = () => (
    <KidsCard title="üìÇ Â§ßÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Å≠" icon="üóÇÔ∏è" color="purple">
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        {filteredItems.map((category: LargeCategory) => (
          <div
            key={category.id}
            onClick={() => handleLargeSelect(category)}
            className="group cursor-pointer transform transition-all duration-200 hover:scale-105"
          >
            <div className="bg-white border-2 border-purple-200 rounded-xl p-4 shadow-md group-hover:shadow-lg group-hover:border-purple-400">
              <div className="text-center">
                <div className="text-4xl mb-2">{category.icon}</div>
                <h3 className="font-bold text-lg text-purple-800 mb-2">{category.name}</h3>
                <p className="text-sm text-gray-600 mb-3">{category.description}</p>
                <div className="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-medium">
                  {category.mediumCategories.length}ÂÄã„ÅÆ‰∏≠ÂçòÂÖÉ
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </KidsCard>
  );

  // ‰∏≠ÂçòÂÖÉË°®Á§∫
  const renderMediumCategories = () => (
    <KidsCard title={`üìÅ ${selectionState.selectedLarge?.name}„ÅÆ‰∏≠ÂçòÂÖÉ`} icon="üìÅ" color="blue">
      <p className="text-sm text-gray-600 mb-4">{selectionState.selectedLarge?.description}</p>
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
        {filteredItems.map((category: MediumCategory) => (
          <KidsButton
            key={category.id}
            onClick={() => handleMediumSelect(category)}
            variant="secondary"
            size="medium"
            className="text-left justify-start h-auto p-4 hover:bg-blue-50"
          >
            <div>
              <div className="font-medium text-base mb-1">{category.name}</div>
              <div className="text-sm text-gray-500 mb-2">{category.description}</div>
              <div className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs inline-block">
                {category.smallCategories.length}ÂÄã„ÅÆÂ∞èÂçòÂÖÉ
              </div>
            </div>
          </KidsButton>
        ))}
      </div>
    </KidsCard>
  );

  // Â∞èÂçòÂÖÉË°®Á§∫
  const renderSmallCategories = () => (
    <KidsCard title={`üìÑ ${selectionState.selectedMedium?.name}„ÅÆÂ∞èÂçòÂÖÉ`} icon="üìÑ" color="green">
      <p className="text-sm text-gray-600 mb-4">{selectionState.selectedMedium?.description}</p>
      <div className="grid grid-cols-1 gap-3">
        {filteredItems.map((category: SmallCategory) => {
          const difficultyColor = getDifficultyColor(category.difficulty);
          const isRecent = recentSelections.includes(category.id);
          
          return (
            <div
              key={category.id}
              onClick={() => handleSmallSelect(category)}
              className={`border-2 rounded-lg p-4 cursor-pointer transition-all duration-200 hover:shadow-md ${
                isRecent 
                  ? 'border-yellow-400 bg-yellow-50' 
                  : 'border-gray-200 hover:border-green-400 bg-white'
              }`}
            >
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-2">
                    <h4 className="font-medium text-gray-800">{category.name}</h4>
                    {isRecent && <span className="text-xs bg-yellow-400 text-yellow-800 px-2 py-1 rounded">ÊúÄËøëÈÅ∏Êäû</span>}
                  </div>
                  <p className="text-sm text-gray-600 mb-3">{category.description}</p>
                  
                  <div className="flex items-center flex-wrap gap-2 mb-2">
                    <span className={`px-2 py-1 rounded text-white text-xs ${difficultyColor}`}>
                      {getDifficultyLabel(category.difficulty)} (Lv.{category.difficulty})
                    </span>
                    <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                      ‚è±Ô∏è Á¥Ñ{category.estimatedHours}ÊôÇÈñì
                    </span>
                  </div>
                  
                  {category.keywords.length > 0 && (
                    <div className="flex flex-wrap gap-1">
                      {category.keywords.slice(0, 3).map(keyword => (
                        <span key={keyword} className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
                          {keyword}
                        </span>
                      ))}
                      {category.keywords.length > 3 && (
                        <span className="text-xs text-gray-500">+{category.keywords.length - 3}ÂÄã</span>
                      )}
                    </div>
                  )}
                </div>
                <div className="text-green-500 text-xl">‚û§</div>
              </div>
            </div>
          );
        })}
      </div>
    </KidsCard>
  );

  // Á¢∫Ë™çÁîªÈù¢
  const renderConfirmation = () => {
    const { selectedLarge, selectedMedium, selectedSmall } = selectionState;
    if (!selectedSmall) return null;

    const difficultyColor = getDifficultyColor(selectedSmall.difficulty);

    return (
      <KidsCard title="‚úÖ Â≠¶ÁøíÂÜÖÂÆπ„ÅÆÁ¢∫Ë™ç" icon="üéØ" color="green">
        <div className="bg-green-50 border-2 border-green-200 rounded-xl p-6">
          <div className="text-center mb-6">
            <h2 className="text-2xl font-bold text-green-800 mb-2">
              {selectedSmall.name}
            </h2>
            <p className="text-green-700">{selectedSmall.description}</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div className="text-center p-4 bg-white rounded-lg">
              <div className="text-2xl mb-2">üìä</div>
              <div className={`inline-block px-3 py-1 rounded text-white text-sm ${difficultyColor}`}>
                {getDifficultyLabel(selectedSmall.difficulty)}
              </div>
              <div className="text-xs text-gray-500 mt-1">Èõ£ÊòìÂ∫¶„É¨„Éô„É´ {selectedSmall.difficulty}</div>
            </div>
            
            <div className="text-center p-4 bg-white rounded-lg">
              <div className="text-2xl mb-2">‚è±Ô∏è</div>
              <div className="font-bold text-lg text-blue-600">{selectedSmall.estimatedHours}ÊôÇÈñì</div>
              <div className="text-xs text-gray-500">‰∫àÊÉ≥Â≠¶ÁøíÊôÇÈñì</div>
            </div>
            
            <div className="text-center p-4 bg-white rounded-lg">
              <div className="text-2xl mb-2">üéØ</div>
              <div className="font-bold text-lg text-purple-600">{selectedSmall.keywords.length}ÂÄã</div>
              <div className="text-xs text-gray-500">Â≠¶Áøí„Ç≠„Éº„ÉØ„Éº„Éâ</div>
            </div>
          </div>

          <div className="mb-6">
            <h4 className="font-medium text-gray-800 mb-2">Â≠¶Áøí„Éë„Çπ:</h4>
            <div className="bg-white p-3 rounded-lg text-sm">
              <span className="text-blue-600">{selectedLarge?.name}</span>
              <span className="text-gray-400 mx-2">‚Üí</span>
              <span className="text-blue-600">{selectedMedium?.name}</span>
              <span className="text-gray-400 mx-2">‚Üí</span>
              <span className="text-green-600 font-medium">{selectedSmall.name}</span>
            </div>
          </div>

          <StudyStartButton
            subjectName="ÁÆóÊï∞"
            topicName={selectedSmall.name}
            estimatedTime={selectedSmall.estimatedHours * 60}
            disabled={disabled}
            onStart={handleStartLearning}
          />
        </div>
      </KidsCard>
    );
  };

  return (
    <div className="space-y-6">
      {/* „Çø„Ç§„Éà„É´ */}
      <div className="text-center">
        <h2 className="text-4xl font-bold text-sky-700 mb-4">üßÆ ÁÆóÊï∞„ÅÆÂçòÂÖÉ„ÇíÈÅ∏„Åº„ÅÜÔºÅ</h2>
        <p className="text-lg text-slate-600">Â§ßÂçòÂÖÉ„Åã„ÇâÈ†ÜÁï™„Å´ÈÅ∏„Çì„Åß„ÅÑ„Åè„Çà</p>
      </div>

      {/* „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */}
      {renderStepIndicator()}

      {/* „Éë„É≥„Åè„Åö„É™„Çπ„Éà */}
      {(selectionState.selectedLarge || selectionState.selectedMedium || selectionState.selectedSmall) && renderBreadcrumb()}

      {/* Êàª„Çã„Éú„Çø„É≥ */}
      {selectionState.step !== 'large' && (
        <div className="flex justify-start">
          <KidsButton
            onClick={handleBack}
            variant="secondary"
            size="medium"
            icon="‚¨ÖÔ∏è"
          >
            Êàª„Çã
          </KidsButton>
        </div>
      )}

      {/* Ê§úÁ¥¢„Éê„Éº */}
      {renderSearchBar()}

      {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
      {selectionState.step === 'large' && renderLargeCategories()}
      {selectionState.step === 'medium' && renderMediumCategories()}
      {selectionState.step === 'small' && renderSmallCategories()}
      {selectionState.step === 'confirm' && renderConfirmation()}

      {/* Ê§úÁ¥¢ÁµêÊûú„ÅåÁ©∫„ÅÆÂ†¥Âêà */}
      {filteredItems.length === 0 && searchTerm && selectionState.step !== 'confirm' && (
        <div className="text-center py-8">
          <div className="text-4xl mb-4">üîç</div>
          <h3 className="text-xl font-medium text-gray-800 mb-2">Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</h3>
          <p className="text-gray-600 mb-4">„Äå{searchTerm}„Äç„Å´Èñ¢„Åô„ÇãÂçòÂÖÉ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
          <KidsButton
            onClick={() => setSearchTerm('')}
            variant="primary"
            size="medium"
            icon="üîÑ"
          >
            Ê§úÁ¥¢„Çí„ÇØ„É™„Ç¢
          </KidsButton>
        </div>
      )}
    </div>
  );
};

export default ImprovedHierarchicalSelector;